{% include "header.html" %}

<div class="container-fluid" id="location">
    <div class="row">
    <div id="places-title">
    <div class="position-relative d-lg-none my-2" id="filter-commands">
    <button class="btn btn-default d-md-none" data-show="#places-filters" data-toggle="button" type="button">
    <i class="fa fa-fw fa-filter"></i>
    <span></span>
    </button>
    <button class="btn btn-default d-md-none" data-show="#places-map" data-toggle="button" id="places-map-button" type="button">
    <i class="fa fa-fw fa-map"></i>
    <span></span>
    </button>
    </div>
    {%if all_cafes%}
    <h1 class="px-3 offset-lg-3 offset-md-4 col-lg-5 col-md-8">{{all_cafes[0].borough}}</h1>
    </div>
    <!-- Places Filters -->
    <div class="position-relative col-lg-3 col-md-4 d-md-block" id="places-filters">
    <h2 class="d-none d-md-block">
    Filters
    <span id="filters-count"></span>
    </h2>
    <div class="filters">
{% set disable_like_button = True %}
{% if current_user.is_authenticated %}
    {% set disable_like_button = False %}
{% endif %}
    <h3>My Places</h3>
    <div class="row no-gutters">
    <div class="col-3 col-xl-3 col-lg-4 py-1">
<button class="btn btn-filter" 
        data-criteria="i-like-it" 
        data-action="liked" 
        data-toggle="button" 
        {% if disable_like_button %}disabled{% endif %}>
    <div data-content="Please log in to use this feature." data-original-title="Warning" data-template="<div class='popover low-border' role='tooltip'><div class='arrow'></div><div class='popover-header'></div><div class='popover-body'></div></div>" data-toggle="popover">
    <i class="fa fa-heart"></i>
    <br>
    <span title="Liked">Liked</span>
    </div>
    </button>
    </div>
    </div>
    <h3>Productivity</h3>
    <div class="row no-gutters">
    <div class="col-3 col-xl-3 col-lg-4 py-1">
    <button class="btn btn-filter" data-criteria="wifi" data-toggle="button">
    <i class="fa fa-fw fa-wifi"></i>
    <br>
    <span title="Stable Wi-Fi">
    Wi-Fi
    </span>
    </button>
    </div>
    <div class="col-3 col-xl-3 col-lg-4 py-1">
    <button class="btn btn-filter" data-criteria="sockets" data-toggle="button">
    <i class="fa fa-fw fa-plug"></i>
    <br>
    <span title="Power sockets">
    Sockets
    </span>
    </button>
    </div>
    <div class="col-3 col-xl-3 col-lg-4 py-1">
    <button class="btn btn-filter" data-criteria="long-stay" data-toggle="button">
    <i class="fa fa-fw fa-user-clock"></i>
    <br>
    <span title="Long stays">
    Long stays
    </span>
    </button>
    </div>
    <div class="col-3 col-xl-3 col-lg-4 py-1">
    <button class="btn btn-filter" data-criteria="tables" data-toggle="button">
    <i class="fa fa-fw fa-pen-square"></i>
    <br>
    <span title="Work-friendly tables">
    Tables
    </span>
    </button>
    </div>
    <div class="col-3 col-xl-3 col-lg-4 py-1">
    <button class="btn btn-filter" data-criteria="quiet" data-toggle="button">
    <i class="fa fa-fw fa-volume-down"></i>
    <br>
    <span title="Quiet">
    Quiet
    </span>
    </button>
    </div>
    <div class="col-3 col-xl-3 col-lg-4 py-1">
    <button class="btn btn-filter" data-criteria="calls" data-toggle="button">
    <i class="fa fa-fw fa-headset"></i>
    <br>
    <span title="Video/audio calls">
    Calls
    </span>
    </button>
    </div>
    </div>
    
    <h3>Community</h3>
    <div class="row no-gutters">
    <div class="col-3 col-xl-3 col-lg-4 py-1">
    <button class="btn btn-filter" data-criteria="vibe" data-toggle="button">
    <i class="fa fa-fw fa-laptop"></i>
    <br>
    <span title="People working">
    Work vibe
    </span>
    </button>
    </div>
    <div class="col-3 col-xl-3 col-lg-4 py-1">
    <button class="btn btn-filter" data-criteria="groups" data-toggle="button">
    <i class="fa fa-fw fa-users"></i>
    <br>
    <span title="Group tables">
    Groups
    </span>
    </button>
    </div>
    </div>
    
    <h3>Service</h3>
    <div class="row no-gutters">
    <div class="col-3 col-xl-3 col-lg-4 py-1">
    <button class="btn btn-filter" data-criteria="coffee" data-toggle="button">
    <i class="fa fa-fw fa-coffee"></i>
    <br>
    <span title="Coffee">
    Coffee
    </span>
    </button>
    </div>
    <div class="col-3 col-xl-3 col-lg-4 py-1">
    <button class="btn btn-filter" data-criteria="food" data-toggle="button">
    <i class="fa fa-fw fa-utensils"></i>
    <br>
    <span title="Food">
    Food
    </span>
    </button>
    </div>
    <div class="col-3 col-xl-3 col-lg-4 py-1">
    <button class="btn btn-filter" data-criteria="veggie" data-toggle="button">
    <i class="fa fa-fw fa-leaf"></i>
    <br>
    <span title="Veggie">
    Veggie
    </span>
    </button>
    </div>
    <div class="col-3 col-xl-3 col-lg-4 py-1">
    <button class="btn btn-filter" data-criteria="alcohol" data-toggle="button">
    <i class="fa fa-fw fa-glass-martini"></i>
    <br>
    <span title="Alcohol">
    Alcohol
    </span>
    </button>
    </div>
    <div class="col-3 col-xl-3 col-lg-4 py-1">
    <button class="btn btn-filter" data-criteria="credit-cards" data-toggle="button">
    <i class="fa fa-fw fa-credit-card"></i>
    <br>
    <span title="Credit cards">
    Cards
    </span>
    </button>
    </div>
    </div>
    
    <h3>Space</h3>
    <div class="row no-gutters">
    <div class="col-3 col-xl-3 col-lg-4 py-1">
    <button class="btn btn-filter" data-criteria="light" data-toggle="button">
    <i class="fa fa-fw fa-sun"></i>
    <br>
    <span title="Natural light">
    Light
    </span>
    </button>
    </div>
    <div class="col-3 col-xl-3 col-lg-4 py-1">
    <button class="btn btn-filter" data-criteria="outdoor" data-toggle="button">
    <i class="fa fa-fw fa-tree"></i>
    <br>
    <span title="Outdoor area">
    Outdoor
    </span>
    </button>
    </div>
    <div class="col-3 col-xl-3 col-lg-4 py-1">
    <button class="btn btn-filter" data-criteria="spacious" data-toggle="button">
    <i class="fa fa-fw fa-arrows-alt"></i>
    <br>
    <span title="Spacious">
    Spacious
    </span>
    </button>
    </div>
    <div class="col-3 col-xl-3 col-lg-4 py-1">
    <button class="btn btn-filter" data-criteria="toilets" data-toggle="button">
    <i class="fa fa-fw fa-toilet-paper"></i>
    <br>
    <span title="Restroom">
    Restroom
    </span>
    </button>
    </div>
    <div class="col-3 col-xl-3 col-lg-4 py-1">
    <button class="btn btn-filter" data-criteria="access" data-toggle="button">
    <i class="fa fa-fw fa-wheelchair"></i>
    <br>
    <span title="Accessible">
    Accessible
    </span>
    </button>
    </div>
    <div class="col-3 col-xl-3 col-lg-4 py-1">
    <button class="btn btn-filter" data-criteria="ac" data-toggle="button">
    <i class="fa fa-fw fa-thermometer-half"></i>
    <br>
    <span title="Air conditioned">
    A/C
    </span>
    </button>
    </div>
    <div class="col-3 col-xl-3 col-lg-4 py-1">
    <button class="btn btn-filter" data-criteria="pets" data-toggle="button">
    <i class="fa fa-fw fa-dog"></i>
    <br>
    <span title="Pet friendly">
    Pets
    </span>
    </button>
    </div>
    <div class="col-3 col-xl-3 col-lg-4 py-1">
    <button class="btn btn-filter" data-criteria="parking" data-toggle="button">
    <i class="fa fa-fw fa-car"></i>
    <br>
    <span title="Parking">
    Parking
    </span>
    </button>
    </div>
    </div>
    
    </div>
    
    </div>
    <!-- Places List -->
    <div class="offset-lg-3 offset-md-4 col-lg-5 col-md-8 order-2" id="places-list">
    <p>Check out the best cafes in {{all_cafes[0].borough}} for work and study sessions. Find cosy spots with free, reliable Wi-Fi, plenty of power outlets, comfy seating, and tasty coffee!</p>
    {%endif%}
    <!-- Vibes -->
    
    <!-- List -->
    <h2 data-places="275" id="best_match">{{all_cafes|length}} Work-Friendly Places</h2>
    <div class="list" id="cafe-list">
    <!-- LaptopFriendly Hubs -->
    <!-- All Places -->
    {%for cafe in all_cafes  | sort(attribute='score', reverse=True)%}
        {% if current_user.is_authenticated %}
        {% set like_level = current_user.get_like_level(cafe.id) %}
        {% set cafe_score = current_user.get_score(cafe.id) %}
    {% else %}
        {% set like_level = "unknown" %}
        {% set cafe_score = cafe.score %}
    {% endif %}
    <a id={{make_slug(cafe.name)}} class="place" data-wifi="{{cafe.criterion['wifi']}}" data-sockets="{{cafe.criterion['sockets']}}" data-long-stay="{{cafe.criterion['long_stay']}}" data-light="{{cafe.criterion['light']}}" data-quiet="{{cafe.criterion['quiet']}}" data-calls="{{cafe.criterion['calls']}}" data-vibe="{{cafe.criterion['vibe']}}" data-ac="{{cafe.criterion['ac']}}" data-tables="{{cafe.criterion['tables']}}" data-groups="{{cafe.criterion['groups']}}" data-food="{{cafe.criterion['food']}}" data-credit-cards="{{cafe.criterion['credit_cards']}}" data-parking="{{cafe.criterion['parking']}}" data-access="{{cafe.criterion['access']}}" data-outdoor="{{cafe.criterion['outdoor']}}" data-pets="{{cafe.criterion['pets']}}" data-spacious="{{cafe.criterion['spacious']}}" data-coffee="{{cafe.criterion['coffee']}}" data-alcohol="{{cafe.criterion['alcohol']}}" data-veggie="{{cafe.criterion['veggie']}}" data-i-like-it="{{like_level}}" data-toilets="{{cafe.criterion['toilets']}}" data-score="{{cafe_score}}" href="{{ url_for('show_cafe', cafe_id=cafe.id) }}" style="order: 124;"><div class="card-img-top">
    <img alt={{cafe.name}} src={{cafe.img_url}}>
    </div>
    <div class="card-body">
    <div class="score" data-score="{{cafe_score}}" data-i-like-it="{{like_level}}" data-toggle="popover" data-content="I have not been here yet" data-template="<div class='popover unknown-border' role='tooltip'><div class='arrow'></div><div class='popover-header'></div><div class='popover-body'></div></div>" data-bs-original-title="In general, do you like working from here?"><i class="far fa-heart grey" data-color="grey"></i> | {{cafe_score}}%</div>
    <h3 class="card-title">{{cafe.name}}</h3>
    <p>
    <i class="far fa-clock"></i>
    {% for day, time in cafe.opening_hours.items() %}
      {% if day == current_day %}
        {{ time }}
        {% endif %}
    {% endfor %}
    </p>
    <p class="card-text">
    <i class="fa fa-location-arrow"></i>
    {{cafe.address}}
    </p>
    <div class="active-filters"></div>
    </div>
    </a>
    {%endfor%}
    </div>
    <!-- Suggest a Place -->
    <a id="suggest_link" class="suggest" href="/suggest"><div class="card-img-top">
    <i class="fa fa-plus-circle fa-4x"></i>
    <img src="/static/assets/gray-place-d2bdb4477600e061c01bd816cc0f2ef0cfcb1ca9e3ad78868dd16fb2af073a21.png">
    </div>
    <div class="card-body">
    <h3 class="card-title">Suggest a Venue</h3>
    <p class="card-text">Work from your borough</p>
    </div>
    </a>
    </div>
    <!-- Places Map -->
    <script src="https://maps.googleapis.com/maps/api/js?key={{google_api_key}}"></script>
    <div id="map-container">
    <div id="map"></div>
  </div>
  <script>
var currentInfoWindow = null;
var openedInfoWindow = null;
var markers = {};

function initMap() {
    var map = new google.maps.Map(document.getElementById('map'), {
        center: {lat: {{borough_lat}}, lng: {{borough_lng}}}, // Borough coordinates
        zoom: 12,
        disableDefaultUI: true, // Disable default UI controls
        zoomControl: true, // Enable zoom control
        scaleControl: true, // Enable scale control
        mapTypeControl: false // Disable map type controls
    });

    // Array of locations in London with their coordinates
    var locations = [];
    {% for cafe in all_cafes %}
    locations.push({
        lat: {{ cafe.lat }},
        lng: {{ cafe.lng }},
        name: "{{ cafe.name }}",
        slugged_name: "{{ make_slug(cafe.name) }}",
        url: "{{ url_for('show_cafe', cafe_id=cafe.id) }}"
    });
    {% endfor %}

    // Loop through the locations array and add markers
    locations.forEach(function(location) {
        var marker = new google.maps.Marker({
            position: location,
            map: map,
            title: location.name // Marker title
        });

        var infowindow = new google.maps.InfoWindow({
            content: '<a href="' + location.url + '" class="link">' + location.name + '</a>'
        });

        // Open info window on hover
        marker.addListener('mouseover', function() {
            if (currentInfoWindow && currentInfoWindow !== openedInfoWindow) {
                currentInfoWindow.close();
            }
            infowindow.open(map, marker);
            currentInfoWindow = infowindow;
        });

        // Toggle info window on click
        marker.addListener('click', function() {
            if (openedInfoWindow === infowindow) {
                infowindow.close();
                openedInfoWindow = null;
            } else {
                if (openedInfoWindow) {
                    openedInfoWindow.close();
                }
                infowindow.open(map, marker);
                openedInfoWindow = infowindow;
            }
        });

        // Close info window on mouseout if it's not the clicked one
        marker.addListener('mouseout', function() {
            if (currentInfoWindow !== openedInfoWindow) {
                currentInfoWindow.close();
                currentInfoWindow = null;
            }
        });

        markers[location.slugged_name] = { marker: marker, infowindow: infowindow };
    });
}

document.addEventListener('DOMContentLoaded', function() {
    // Score color
    const scoreElements = document.querySelectorAll('.score');

    scoreElements.forEach(element => {
        const scoreValue = parseInt(element.dataset.score);

        if (scoreValue >= 0 && scoreValue < 50) {
            element.className = 'red score';
        } else if (scoreValue >= 50 && scoreValue < 80) {
            element.className = 'yellow score';
        } else if (scoreValue >= 80) {
            element.className = 'green score';
        }
    });

    // Score heart colors
    const cafeElements = document.querySelectorAll('.place');

    cafeElements.forEach(element => {
        const likeValue = element.dataset.iLikeIt;
        const icon = element.querySelector('.score i');
        if (likeValue === 'low') {
            icon.className = 'fa fa-heart-broken red';
        } else if (likeValue === 'medium') {
            icon.className = 'fa fa-heart yellow';
        } else if (likeValue === 'high') {
            icon.className = 'fa fa-heart green';
        }

        // Add hover event to show marker info window
        element.addEventListener('mouseover', function() {
            const cafeName = element.id;
            if (markers[cafeName]) {
                if (currentInfoWindow && currentInfoWindow !== openedInfoWindow) {
                    currentInfoWindow.close();
                }
                markers[cafeName].infowindow.open(map, markers[cafeName].marker);
                currentInfoWindow = markers[cafeName].infowindow;
            }
        });

        element.addEventListener('mouseout', function() {
            if (currentInfoWindow !== openedInfoWindow) {
                currentInfoWindow.close();
                currentInfoWindow = null;
            }
        });
    });

    const criteriaButtons = document.querySelectorAll('.btn-filter');
    const criteriaPriority = { 'high': 1, 'medium': 2, 'unknown': 3, 'low': 4 };
    let activeCriteria = [];
    const cafeList = document.getElementById('cafe-list');
    const cafes = Array.from(cafeList.getElementsByClassName('place'));
    const originalOrder = cafes.slice(); // Store the original order

    function camelCase(str) {
        return str.replace(/-([a-z])/g, function (g) { return g[1].toUpperCase(); });
    }

    function getCriteriaPriority(cafe, criterion) {
        return criteriaPriority[cafe.dataset[camelCase(criterion)]] || 5; // Default to 5 if not found
    }

    function sortCafes(criteria) {
        if (criteria.length === 0) {
            // No criteria selected, restore original order
            cafeList.innerHTML = ''; // Clear the cafe list
            originalOrder.forEach(cafe => {
                cafeList.appendChild(cafe);
            });
            return;
        }

        const filteredCafes = cafes.filter(cafe => {
            for (let criterion of criteria) {
                if (cafe.dataset[camelCase(criterion)] === 'low') {
                    return false; // Exclude cafes with 'low' value for any active criterion
                }
                if (cafe.dataset[camelCase(criterion)] === 'unknown' && criterion=='i-like-it'){
                    return false;
                }
            }
            return true;
        });

        filteredCafes.sort((a, b) => {
            for (let criterion of criteria) {
                let priorityA = getCriteriaPriority(a, criterion);
                let priorityB = getCriteriaPriority(b, criterion);
                if (priorityA !== priorityB) {
                    return priorityA - priorityB;
                }
            }
            return 0; // If all criteria are equal, maintain original order
        });

        // Clear the cafe list and reinsert filtered and sorted elements
        cafeList.innerHTML = '';
        filteredCafes.forEach(cafe => {
            cafeList.appendChild(cafe);
        });
    }

    function updateActiveFilters() {
        cafes.forEach(cafe => {
            const activeFiltersDiv = cafe.querySelector('.active-filters');
            activeFiltersDiv.innerHTML = ''; // Clear existing active filters

            criteriaButtons.forEach(button => {
                const criterion = button.dataset.criteria;
                if (activeCriteria.includes(criterion)) {
                    const score = cafe.dataset[camelCase(criterion)];
                    const span = document.createElement('span');
                    
                    if (criterion == 'i-like-it') {
                        span.classList.add('active-filter', `likes`);
                        span.classList.add('active-filter', `${score}`);
                    } else {
                        span.classList.add('active-filter', `${score}`);
                        const icon = button.querySelector('i').outerHTML;
                        span.innerHTML = icon;
                    }

                    activeFiltersDiv.appendChild(span);
                }
            });
        });
    }

    criteriaButtons.forEach(button => {
        button.addEventListener('click', function() {
            const isSet = button.classList.contains('set');
            const criterion = button.dataset.criteria;

            if (!isSet) {
                button.classList.add('set');
                activeCriteria.push(criterion);
            } else {
                button.classList.remove('set');
                activeCriteria = activeCriteria.filter(c => c !== criterion);
            }

            sortCafes(activeCriteria);
            updateActiveFilters();
        });
    });
});



window.onload = function() {
    initMap();
};
</script>

